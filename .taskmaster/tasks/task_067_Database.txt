# Task ID: 67
# Cross-tag dependencies: see .taskmaster/dependencies.md
# Title: Finalize schema design and decisions
# Status: pending
# Dependencies: None
# Priority: high
# Description: Define table structures, constraints, and indexing strategy for core.items and core.item_embeddings, including embedding dimension and distance metric.
# Details:
Decisions and spec:
- Schema: use PostgreSQL schema "core" for namespacing.
- Extensions: pgvector (extension name: vector) for embeddings; pgcrypto for gen_random_uuid().
- Embedding config: dimension=1536, distance=cosine (vector_cosine_ops). Assumption: a single embedding model/dimension used initially. If future models require different dimensions, plan separate tables per dimension or a migration to add new tables.
- Table core.items (unified/fused items from branches):
  - id UUID PRIMARY KEY DEFAULT gen_random_uuid()
  - source_branch TEXT NOT NULL (identifier of the branch the record came from)
  - source_item_id TEXT NOT NULL (stable ID from the branch)
  - canonical_key TEXT NULL (optional cross-branch key)
  - content JSONB NOT NULL (fused item payload)
  - content_hash BYTEA NOT NULL (hash of content for change detection)
  - created_at TIMESTAMPTZ NOT NULL DEFAULT now()
  - updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
  - Constraints/Indexes: UNIQUE (source_branch, source_item_id); BTREE index on canonical_key; GIN index on content jsonb; trigger to maintain updated_at on row change.
- Table core.item_embeddings:
  - id BIGSERIAL PRIMARY KEY
  - item_id UUID NOT NULL REFERENCES core.items(id) ON DELETE CASCADE
  - model TEXT NOT NULL (embedding model name)
  - embedding VECTOR(1536) NOT NULL
  - embedding_version INT NOT NULL DEFAULT 1 (for re-embeddings/versioning)
  - created_at TIMESTAMPTZ NOT NULL DEFAULT now()
  - Constraints/Indexes: UNIQUE (item_id, model, embedding_version); IVFFLAT index on embedding USING vector_cosine_ops WITH (lists=100) for ANN search.
- Migration approach: one migration file implementing both tables (up/down). Name suggestion: 027_core_items_and_embeddings.sql (or equivalent for your migration tool).

# Test Strategy:

